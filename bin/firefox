#!/bin/sh
if [ "x`id -u`" != "x0" ]; then
  if [ -t 0 ]; then
    exec sudo `realpath $0` "$@"
  else
    exec sakura -e sudo `realpath $0` --no-interaction "$@"
  fi
fi

set -e

if echo -- "$@" | grep -q " --update"; then
  cd $HOME/docker/firefox
  docker build --pull=true -t firefox .
fi

if echo -- "$@" | grep -q " --no-interaction"; then
  setsid `realpath $0` "$(echo " " "$@" | sed 's/--no-interaction//')" >/dev/null </dev/null 2>/dev/null &
  sleep 1.5
  exit 0
fi

if echo -- "$@" | grep -q " --remote="; then
  NEW_DISPLAY="$(echo -- "$@" | grep -o ' --remote=[^ ]*' | sed 's/^[^=]*=//')"
fi

mkdir /tmp/firefox || true
chown -R $SUDO_UID:$SUDO_UID /tmp/firefox

if [ -n "$NEW_DISPLAY" ]; then
  EXTRA="-e DISPLAY=$NEW_DISPLAY"
else
  TMP_XAUTH=`mktemp /tmp/.docker-firefox-XXXX`
  xauth nlist :0 | sed -e 's/^..../ffff/' | xauth -f $TMP_XAUTH nmerge -
  chown -R $SUDO_UID:$SUDO_GID $TMP_XAUTH
  EXTRA="-e DISPLAY=$DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix:ro -v $TMP_XAUTH:/home/user/.Xauthority:ro"
fi
if ! echo -- "$@" | grep -q " --nosound"; then
  EXTRA="$EXTRA $(for f in `find /dev/snd -type c`; do echo " --device $f"; done)"
fi
if [ -n "$TMP_XAUTH" ]; then
  (sleep 2; rm -rf $TMP_XAUTH) &
fi
docker run --cap-drop ALL --rm -v /tmp/firefox:/home/user/Downloads/ $EXTRA firefox
find /tmp/firefox -type d -empty -delete
