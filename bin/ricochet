#!/bin/sh
if [ "x`id -u`" != "x0" ]; then
  if [ -t 0 ]; then
    exec sudo `realpath $0` "$@"
  else
    exec sakura -e sudo `realpath $0` --no-interaction "$@"
  fi
fi

set -e

if echo -- "$@" | grep -q " --update"; then
  cd $HOME/docker/ricochet
  docker pull debian
  docker build -t ricochet .
fi

if echo -- "$@" | grep -q " --no-interaction"; then
  setsid `realpath $0` >/dev/null </dev/null 2>/dev/null &
  sleep 1.5
  exit 0
fi

TMP_XAUTH=`mktemp`
xauth nlist :0 | sed -e 's/^..../ffff/' | xauth -f $TMP_XAUTH nmerge -
chown -R $SUDO_UID:$SUDO_GID $TMP_XAUTH
mkdir /tmp/ricochet-state || true
chown -R $SUDO_UID:$SUDO_UID /tmp/ricochet-state
docker run --rm -e DISPLAY=$DISPLAY -v /tmp/ricochet-state:/home/user/ricochet/config/ -v /tmp/.X11-unix:/tmp/.X11-unix:ro -v $TMP_XAUTH:/home/user/.Xauthority:ro ricochet
rm -rf $TMP_XAUTH
